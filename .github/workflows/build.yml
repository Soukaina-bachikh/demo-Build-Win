name: Build 4D Project

on:
  workflow_dispatch:           # Still allow manual trigger anytime

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]

    env:
      TOOL4D_PATH: C:\Users\Admin\Downloads\tool4d_win\tool4d\Tool4D.exe
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build with Tool4D (cmd + log file)
        shell: cmd
        run: |
          echo 🚀 Starting Tool4D build...
          "%TOOL4D_PATH%" --project "C:\Users\Admin\Desktop\demo-Build4D-Win\Project\demo-Build4D-Win.4DProject" --dataless --skip-onstartup --startup-method "buildMethod" > build_output.txt 2>&1
          type build_output.txt
      
      - name: Check build result (PowerShell)
        shell: pwsh
        run: |
          if (-not (Test-Path "build_output.txt")) {
            Write-Error "❌ build_output.txt not found!"
            exit 1
          }
      
          $log = Get-Content build_output.txt -Raw
      
          if ($log -match '❌ Client build failed' -or $log -match '❌ Server build failed') {
            Write-Error "❌ Build failed based on 4D buildMethod logs."
            exit 1
          } elseif ($log -match '✅ All builds succeeded!') {
            Write-Host "✅ Build succeeded."
          } else {
            Write-Error "❌ Build status unclear: missing success/failure messages."
            exit 1
          }
