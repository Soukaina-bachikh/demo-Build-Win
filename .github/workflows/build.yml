name: Build 4D Project

on:
  workflow_dispatch:           # Still allow manual trigger anytime

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]

    env:
      TOOL4D_PATH: C:\Users\Admin\Downloads\tool4d_win\tool4d\Tool4D.exe
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build with Tool4D (live logs + save)
        shell: pwsh
        run: |
          Write-Host "🚀 Starting Tool4D build..."
          & "$env:TOOL4D_PATH" `
            --project "C:\Users\Admin\Desktop\demo-Build4D-Win\Project\demo-Build4D-Win.4DProject" `
            --dataless `
            --skip-onstartup `
            --startup-method "buildMethod" 2>&1 | Tee-Object -FilePath build_output.txt

      - name: Check build result
        shell: pwsh
        run: |
          Write-Host "🔍 Checking build output..."
          $log = Get-Content build_output.txt -Raw
      
          Write-Host "📄 Build Output:"
          Write-Host "----------------------------------------"
          Write-Host $log
          Write-Host "----------------------------------------"
      
          if ($log -notmatch '✅ All builds succeeded!') {
            Write-Error "❌ Build did not complete successfully."
            exit 1
          } else {
            Write-Host "✅ Build log confirms successful execution."
          }
